<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BudgetWise | Reports</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family: "Segoe UI", sans-serif;
  background:#f4f6f8;
}

/* ===== HEADER ===== */
.header{
  display:grid;
  grid-template-columns: 1fr 2fr 1fr;
  align-items:center;
  padding:14px 24px;
  background:linear-gradient(90deg,#6c63ff,#8f7cff);
  color:white;
}

.back{
  cursor:pointer;
  font-size:18px;
}

.tabs{
  display:flex;
  justify-content:center;
  gap:18px;
}

.tab{
  padding:8px 18px;
  border-radius:20px;
  cursor:pointer;
  background:rgba(255,255,255,0.2);
  font-size:14px;
}

.tab.active{
  background:white;
  color:#6c63ff;
  font-weight:600;
}



.theme{
  text-align:right;
}

.theme button{
  border:none;
  background:rgba(255,255,255,0.2);
  color:white;
  padding:8px 12px;
  border-radius:50%;
  cursor:pointer;
}

/* ===== CONTENT ===== */
.container{
  padding:30px;
}

.cards{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  margin-bottom:25px;
}

.card{
  flex:1;
  min-width:260px;
  background:white;
  border-radius:14px;
  padding:20px;
  box-shadow:0 6px 20px rgba(0,0,0,0.1);
}

.amount{
  font-size:28px;
  font-weight:700;
}

.progress{
  height:10px;
  background:#ddd;
  border-radius:10px;
  margin:10px 0;
}

.progress span{
  display:block;
  height:100%;
  width:82%;
  background:#2ecc71;
  border-radius:10px;
}

.charts{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:20px;
  margin-top:20px;
}

/* Responsive */
@media (max-width:1000px){
  .charts{
    grid-template-columns:1fr 1fr;
  }
}

@media (max-width:600px){
  .charts{
    grid-template-columns:1fr;
  }
}

.chart-box{
  background:white;
  border-radius:14px;
  padding:20px;
  box-shadow:0 6px 20px rgba(0,0,0,0.1);
  height:350px;
  display:flex;
  flex-direction:column;
}

.chart-box canvas{
  flex:1;
}

.hidden{display:none;}

body.dark{
  background: #121212;
  color: #f1f1f1;
}

body.dark .card,
body.dark .chart-box{
  background: #1f1f2f;
  color: #ffffff;
}

body.dark h1,
body.dark h3{
  color: #ffffff;
}

.chart-box{
  transition:0.3s;
}

.chart-box:hover{
  transform:translateY(-6px);
  box-shadow:0 15px 35px rgba(0,0,0,0.15);
}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <div class="back" onclick="goBack()">â¬… Back</div>

  <div class="tabs">
  <div class="tab active" onclick="showMonthly(this)">Monthly</div>
  <div class="tab" onclick="showYearly(this)">Yearly</div>
  <div class="tab" onclick="showOverall(this)">Overall</div>
</div>


  

  <div class="theme">
    <button onclick="toggleTheme()">ðŸŒ™</button>
  </div>
</div>
<script>
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "theme",
    document.body.classList.contains("dark")
  );
}

// Apply saved theme on load
window.onload = async () => {

  if(localStorage.getItem("theme") === "true"){
    document.body.classList.add("dark");
  }

  // ðŸ”¥ Fetch latest expenses from backend
  const userId = localStorage.getItem("userId") || "demoUser";

  const res = await fetch(
    `http://localhost:8081/expenses/${userId}`
  );

  const data = await res.json();

  // update localStorage
  localStorage.setItem("expenses", JSON.stringify(data));

  // draw charts using fresh data
  showMonthly(document.querySelector(".tab.active"));
};


</script>

<!-- ===== MONTHLY ===== -->
<div class="container" id="monthly">
  <div class="cards">
    <div class="card">
      <h3>Monthly Budget</h3>
      <div class="amount">0</div>
    </div>

    <div class="card">
      <h3>Amount Spent</h3>
      <div class="amount">0</div>
      <div class="progress"><span></span></div>
      <p style="color:#2ecc71;font-weight:600;">0</p>
    </div>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>Expense Breakdown</h3>
      <canvas id="monthlyPie"></canvas>
    </div>

    <div class="chart-box">
      <h3>Spending Trend</h3>
      <canvas id="monthlyLine"></canvas>
    </div>

    <div class="chart-box">
      <h3>Category Distribution</h3>
      <canvas id="monthlyBar"></canvas>
    </div>
  </div>
</div>

<!-- ===== YEARLY ===== -->
<!-- ===== YEARLY ===== -->
<div class="container hidden" id="yearly">
  <div class="cards">
    <div class="card">
      <h3>Yearly Budget</h3>
      <div class="amount" id="yearlyBudget">â‚¹0</div>
    </div>

    <div class="card">
      <h3>Total Spent</h3>
      <div class="amount" id="yearlySpent">â‚¹0</div>
    </div>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>Yearly Spending Trend</h3>
      <canvas id="yearlyLine"></canvas>
    </div>

    <div class="chart-box">
      <h3>Category Contribution</h3>
      <canvas id="yearlyBar"></canvas>
    </div>
  </div>
</div>


<!-- ===== OVERALL ===== -->
<div class="container hidden" id="overall">
  <div class="cards">
  <div class="card">
    <h3>Remaining</h3>
    <div class="amount" id="overallRemaining">â‚¹0</div>
  </div>

  <div class="card">
    <h3>Monthly Avg</h3>
    <div class="amount" id="overallMonthlyAvg">â‚¹0</div>
  </div>

  <div class="card">
    <h3>Yearly Total</h3>
    <div class="amount" id="overallYearlyTotal">â‚¹0</div>
  </div>
</div>


  <div class="charts">
  <div class="chart-box">
    <h3>Monthly Spending Trend</h3>
    <canvas id="overallMonthlyLine"></canvas>
  </div>

  <div class="chart-box">
    <h3>Yearly Spending Trend</h3>
    <canvas id="overallYearlyLine"></canvas>
  </div>
  </div>

</div>


<script>
/* ===== DATA ===== */
<!-- const expenses = JSON.parse(localStorage.getItem("expenses")) || []; -->
const profile = JSON.parse(localStorage.getItem("profile")) || {};
const income =
  (Number(profile.primaryIncome)||0) +
  (Number(profile.additionalIncome)||0);

const goal = profile.goal || 0;

let charts = {};

function createChart(id, config) {
  if (charts[id]) {
    charts[id].destroy();
  }
  charts[id] = new Chart(document.getElementById(id), config);
}

/* ===== TAB CONTROL ===== */
function activateTab(el, viewId) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  el.classList.add("active");

  document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
  document.getElementById(viewId).classList.remove("hidden");
}

async function loadExpensesFromServer(){

  const userId = localStorage.getItem("userId") || "demoUser";

  const res = await fetch(
    `http://localhost:8081/expenses/${userId}`
  );

  const data = await res.json();

  // store latest copy
  localStorage.setItem("expenses", JSON.stringify(data));

  return data;
}


/* ===== MONTHLY ===== */
function showMonthly(el) {
  activateTab(el, "monthly");

  const expenses = JSON.parse(localStorage.getItem("expenses")) || [];

  const profile = JSON.parse(localStorage.getItem("profile")) || {};
  const income =
    (Number(profile.primaryIncome)||0) +
    (Number(profile.additionalIncome)||0);

  const now = new Date();
  let total = 0;
  const categoryMap = {};
  const weekly = [0,0,0,0];

  expenses.forEach(e=>{
    const d = new Date(e.date);

    if(d.getMonth()===now.getMonth() &&
       d.getFullYear()===now.getFullYear()){

      total += e.amount;

      categoryMap[e.category] =
        (categoryMap[e.category]||0)+e.amount;

      const week=Math.min(3,Math.floor(d.getDate()/7));
      weekly[week]+=e.amount;
    }
  });

  document.querySelector("#monthly .cards .card:nth-child(1) .amount")
    .innerText = formatINR(income);

  document.querySelector("#monthly .cards .card:nth-child(2) .amount")
    .innerText = formatINR(total);

  const percent = income ? (total/income)*100 : 0;
  document.querySelector("#monthly .progress span").style.width = percent+"%";

  createChart("monthlyPie",{
    type:"doughnut",
    data:{
      labels:Object.keys(categoryMap),
      datasets:[{
        data:Object.values(categoryMap),
        backgroundColor:['#6c63ff','#2ecc71','#f39c12','#e74c3c']
      }]
    }
  });

  createChart("monthlyLine",{
    type:"line",
    data:{
      labels:["Week1","Week2","Week3","Week4"],
      datasets:[{data:weekly,borderColor:"#6c63ff",fill:true}]
    }
  });

  createChart("monthlyBar",{
    type:"bar",
    data:{
      labels:Object.keys(categoryMap),
      datasets:[{
        data:Object.values(categoryMap),
        backgroundColor:"#6c63ff"
      }]
    }
  });
}

function formatINR(num){
  return "â‚¹" + Number(num).toLocaleString("en-IN");
}

/* ===== YEARLY ===== */
function showYearly(el) {
  activateTab(el, "yearly");

  const expenses = JSON.parse(localStorage.getItem("expenses")) || [];

  const profile = JSON.parse(localStorage.getItem("profile")) || {};
  const monthlyIncome =
    (Number(profile.primaryIncome)||0) +
    (Number(profile.additionalIncome)||0);

  const yearlyBudget = monthlyIncome * 12;

  const now = new Date();
  const months = Array(12).fill(0);
  const categoryMap = {};
  let yearlySpent = 0;

  expenses.forEach(e => {
    const d = new Date(e.date);

    if (d.getFullYear() === now.getFullYear()) {
      months[d.getMonth()] += e.amount;
      yearlySpent += e.amount;

      categoryMap[e.category] =
        (categoryMap[e.category] || 0) + e.amount;
    }
  });

  document.getElementById("yearlyBudget").innerText = formatINR(yearlyBudget);
  document.getElementById("yearlySpent").innerText = formatINR(yearlySpent);

  createChart("yearlyLine", {
    type: "line",
    data: {
      labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      datasets: [{
        label: "Monthly Spend",
        data: months,
        borderColor: "#6c63ff",
        backgroundColor: "rgba(108,99,255,0.15)",
        fill: true
      }]
    }
  });

  createChart("yearlyBar", {
    type: "bar",
    data: {
      labels: Object.keys(categoryMap),
      datasets: [{
        data: Object.values(categoryMap),
        backgroundColor: "#2ecc71"
      }]
    }
  });
}


function showOverall(el) {
  activateTab(el, "overall");

  const profile = JSON.parse(localStorage.getItem("profile")) || {};
  const monthlyIncome =
  (Number(profile.primaryIncome)||0) +
  (Number(profile.additionalIncome)||0);

  const yearlyIncome = monthlyIncome ;

  const now = new Date();
  const expenses = JSON.parse(localStorage.getItem("expenses")) || [];

  let yearlyTotal = 0;
  let categoryMap = {};
  let monthlyMap = {};
  const months = Array(12).fill(0);

  expenses.forEach(e => {
    const d = new Date(e.date);
    yearlyTotal += e.amount;

    months[d.getMonth()] += e.amount;

    monthlyMap[d.getMonth()] =
      (monthlyMap[d.getMonth()] || 0) + e.amount;

    categoryMap[e.category] =
      (categoryMap[e.category] || 0) + e.amount;
  });

  const monthsCount = Object.keys(monthlyMap).length || 1;
  const monthlyAvg = Math.round(yearlyTotal / monthsCount);
  const remaining = Math.max(yearlyIncome - yearlyTotal, 0);

  document.getElementById("overallRemaining").innerText = formatINR(remaining);
  document.getElementById("overallMonthlyAvg").innerText =formatINR(monthlyAvg);
  document.getElementById("overallYearlyTotal").innerText = formatINR(yearlyTotal);

  createChart("overallPie", {
    type: "doughnut",
    data: {
      labels: Object.keys(categoryMap),
      datasets: [{
        data: Object.values(categoryMap),
        backgroundColor: [
          "#6c63ff","#2ecc71","#f39c12","#e74c3c","#9b59b6"
        ]
      }]
    }
  });

  createChart("overallMonthlyLine", {
    type: "line",
    data: {
      labels: Object.keys(monthlyMap).map(m => `Month ${Number(m)+1}`),
      datasets: [{
        data: Object.values(monthlyMap),
        borderColor: "#2ecc71",
        fill: true
      }]
    }
  });

  createChart("overallYearlyLine", {
    type: "line",
    data: {
      labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      datasets: [{
        data: months,
        borderColor: "#6c63ff",
        fill: true
      }]
    }
  });
}


/* ===== CHART HELPERS ===== */
function resetChart(id){
  if(charts[id]) charts[id].destroy();
}
async function loadExpenses(){
  const userId = localStorage.getItem("userId") || "demoUser";

  const res = await fetch(
    `http://localhost:8081/expenses/${userId}`
  );

  const data = await res.json();

  localStorage.setItem("expenses", JSON.stringify(data));

  return data;
}

function drawPie(id, map){
  resetChart(id);
  charts[id] = new Chart(document.getElementById(id),{
    type:"doughnut",
    data:{
      labels:Object.keys(map),
      datasets:[{
        data:Object.values(map),
        backgroundColor:['#6c63ff','#2ecc71','#f39c12','#e74c3c','#9b59b6']
      }]
    }
  });
}

function drawLine(id, spent){
  resetChart(id);
  charts[id] = new Chart(document.getElementById(id),{
    type:"line",
    data:{
      labels:["Week 1","Week 2","Week 3","Week 4"],
      datasets:[{
        data:[spent/4, spent/4, spent/4, spent/4],
        fill:true,
        borderColor:"#6c63ff"
      }]
    }
  });
}

function drawLineChart(id, data){
  resetChart(id);
  charts[id] = new Chart(document.getElementById(id),{
    type:"line",
    data:{
      labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets:[{
        data:data,
        fill:true,
        borderColor:"#6c63ff"
      }]
    }
  });
}

function drawBar(id, map){
  resetChart(id);
  charts[id] = new Chart(document.getElementById(id),{
    type:"bar",
    data:{
      labels:Object.keys(map),
      datasets:[{
        data:Object.values(map),
        backgroundColor:"#6c63ff"
      }]
    }
  });
}

function drawBarChart(id, data){
  resetChart(id);
  charts[id] = new Chart(document.getElementById(id),{
    type:"bar",
    data:{
      labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets:[{
        data:data,
        backgroundColor:"#6c63ff"
      }]
    }
  });
}

/* ===== NAV ===== */
function goBack(){
  window.location.href="dashboard.html";
}

/* ===== DEFAULT LOAD ===== */
</script>


</body>
</html>
